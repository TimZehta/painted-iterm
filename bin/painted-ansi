#!/bin/bash
# https://github.com/TimZehta/painted-iterm
#### SETUP ####################################################################
set -o errexit
set -o nounset

prog="${0##*/}"
usage="\
Usage:  ${prog} ANSI
        ${prog} -h

Set iTerm2 window color from ANSI/xterm color code.
"
ansi_to_rgb=(   000-000-000 128-000-000 000-128-000 128-128-000 000-000-128
    128-000-128 000-128-128 192-192-192 128-128-128 255-000-000 000-255-000
    255-255-000 000-000-255 255-000-255 000-255-255 255-255-255 000-000-000
    000-000-095 000-000-135 000-000-175 000-000-215 000-000-255 000-095-000
    000-095-095 000-095-135 000-095-175 000-095-215 000-095-255 000-135-000
    000-135-095 000-135-135 000-135-175 000-135-215 000-135-255 000-175-000
    000-175-095 000-175-135 000-175-175 000-175-215 000-175-255 000-215-000
    000-215-095 000-215-135 000-215-175 000-215-215 000-215-255 000-255-000
    000-255-095 000-255-135 000-255-175 000-255-215 000-255-255 095-000-000
    095-000-095 095-000-135 095-000-175 095-000-215 095-000-255 095-095-000
    095-095-095 095-095-135 095-095-175 095-095-215 095-095-255 095-135-000
    095-135-095 095-135-135 095-135-175 095-135-215 095-135-255 095-175-000
    095-175-095 095-175-135 095-175-175 095-175-215 095-175-255 095-215-000
    095-215-095 095-215-135 095-215-175 095-215-215 095-215-255 095-255-000
    095-255-095 095-255-135 095-255-175 095-255-215 095-255-255 135-000-000
    135-000-095 135-000-135 135-000-175 135-000-215 135-000-255 135-095-000
    135-095-095 135-095-135 135-095-175 135-095-215 135-095-255 135-135-000
    135-135-095 135-135-135 135-135-175 135-135-215 135-135-255 135-175-000
    135-175-095 135-175-135 135-175-175 135-175-215 135-175-255 135-215-000
    135-215-095 135-215-135 135-215-175 135-215-215 135-215-255 135-255-000
    135-255-095 135-255-135 135-255-175 135-255-215 135-255-255 175-000-000
    175-000-095 175-000-135 175-000-175 175-000-215 175-000-255 175-095-000
    175-095-095 175-095-135 175-095-175 175-095-215 175-095-255 175-135-000
    175-135-095 175-135-135 175-135-175 175-135-215 175-135-255 175-175-000
    175-175-095 175-175-135 175-175-175 175-175-215 175-175-255 175-215-000
    175-215-095 175-215-135 175-215-175 175-215-215 175-215-255 175-255-000
    175-255-095 175-255-135 175-255-175 175-255-215 175-255-255 215-000-000
    215-000-095 215-000-135 215-000-175 215-000-215 215-000-255 215-095-000
    215-095-095 215-095-135 215-095-175 215-095-215 215-095-255 215-135-000
    215-135-095 215-135-135 215-135-175 215-135-215 215-135-255 215-175-000
    215-175-095 215-175-135 215-175-175 215-175-215 215-175-255 215-215-000
    215-215-095 215-215-135 215-215-175 215-215-215 215-215-255 215-255-000
    215-255-095 215-255-135 215-255-175 215-255-215 215-255-255 255-000-000
    255-000-095 255-000-135 255-000-175 255-000-215 255-000-255 255-095-000
    255-095-095 255-095-135 255-095-175 255-095-215 255-095-255 255-135-000
    255-135-095 255-135-135 255-135-175 255-135-215 255-135-255 255-175-000
    255-175-095 255-175-135 255-175-175 255-175-215 255-175-255 255-215-000
    255-215-095 255-215-135 255-215-175 255-215-215 255-215-255 255-255-000
    255-255-095 255-255-135 255-255-175 255-255-215 255-255-255 008-008-008
    018-018-018 028-028-028 038-038-038 048-048-048 058-058-058 068-068-068
    078-078-078 088-088-088 096-096-096 102-102-102 118-118-118 128-128-128
    138-138-138 148-148-148 158-158-158 168-168-168 178-178-178 188-188-188
    198-198-198 208-208-208 218-218-218 228-228-228 238-238-238)

#### FUNCTIONS ################################################################


error_and_exit() {
    # Print error message, then exit with exit status of 1.
    echo "ERROR: ${1}" 1>&2
    exit ${2:-1}
}


help_print() {
    # Print help/usage, then exit (incorrect usage should exit 2).
    # Default exit status is 0.
    echo "${usage}"
    exit ${1:-0}
}


help_request_check() {
    # Determine if help/usage has been requested and print it
    for _arg in "${@}"
    do
        case "${_arg}" in
            '-H' | '-h' | '-help' | '--help' | 'help' ) help_print ;;
        esac
    done
    return 0
}


#### MAIN #####################################################################

# Parse arguments
help_request_check "${@:-}"
ansi=${1:-}

# Validate arguments
[[ -n "${ansi}" ]] || error_and_exit 'missing ANSI color value' 2
(( ansi >= 0 )) \
    || error_and_exit 'invalid ANSI color value (must be >= 0)' 2
(( ansi <= 255 )) \
    || error_and_exit 'invalid ANSI color value (must be <= 255)' 2

rgb=${ansi_to_rgb[${ansi}]}
# extract values and convert from base10 to base10 to drop leading zeros
R=$(( 10#${rgb:0:3} ))
G=$(( 10#${rgb:4:3} ))
B=$(( 10#${rgb:8:3} ))

# Output to stderr to prevent noise when used with SSH LocalCommand, etc.
printf '\e]6;1;bg;red;brightness;%d\a' ${R} 1>&2
printf '\e]6;1;bg;green;brightness;%d\a' ${G} 1>&2
printf '\e]6;1;bg;blue;brightness;%d\a' ${B} 1>&2
